FROM rust:1.65

ARG APPLGRID_V=1.6.27
ARG CARGOC_V=0.9.14+cargo-0.67
ARG FASTNLO_V=2.5.0-2826
ARG LHAPDF_V=6.4.0

ENV APPL_IGRID_DIR="/usr/local/src/applgrid-${APPLGRID_V}/src"

RUN mkdir /build && cd build \
 && apt update && apt install gfortran -y \
 && rustup component add llvm-tools-preview \
 && cargo install cargo-c --version ${CARGOC_V} \
 && rm -r /usr/local/cargo/registry \
 && wget --no-verbose "https://lhapdf.hepforge.org/downloads/?f=LHAPDF-${LHAPDF_V}.tar.gz" -O - | tar xzf - \
 && cd LHAPDF-${LHAPDF_V} \
 && ./configure --disable-python --disable-static && make -j && make install && ldconfig \
 && cd .. \
 && for pdf in NNPDF31_nlo_as_0118_luxqed NNPDF40_nnlo_as_01180 NNPDF40_nlo_as_01180; do \
        wget --no-verbose "https://lhapdfsets.web.cern.ch/current/${pdf}.tar.gz" -O - | tar xzf - -C /usr/local/share/LHAPDF; \
    done \
 && wget --no-verbose "http://applgrid.hepforge.org/downloads/applgrid-${APPLGRID_V}.tgz" -O - | tar xzf - \
 && cd applgrid-${APPLGRID_V} \
 && ./configure --disable-static --without-root && make -j && make install && ldconfig \
 && mkdir -p ${APPL_IGRID_DIR} && cp src/*.h ${APPL_IGRID_DIR} \
 && cd .. \
 && wget --no-verbose "https://fastnlo.hepforge.org/code/v25/fastnlo_toolkit-${FASTNLO_V}.tar.gz" -O - | tar xzf - \
 && cd fastnlo_toolkit-${FASTNLO_V} \
 && ./configure --disable-static --prefix=/usr/local/ && make -j && make install && ldconfig \
 && cd .. \
 && rm -r /build
