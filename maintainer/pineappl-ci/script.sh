#!/bin/bash

set -euo pipefail

# print this so we can see whether the compiler/linker has `--enable-default-pie` enabled; if it's
# not enabled we need to build our dependencies with `--with-pic=yes` (see below)
echo "--- COMPILER/LINKER INFORMATION"
echo "int main() {}" > test.c
cc -Q -v test.c
echo "---"

# install rustup
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y

for version in ${RUST_V}; do
    # the last command will be the default
    rustup default ${version}
    # install LLVM tools needed for code coverage
    # this is now called `llvm-tools`, but for 1.64 it's still called `llvm-tools-preview`
    rustup component add llvm-tools-preview
done

# # install Fortran compiler
# apt update
# apt install gfortran -y

# needed by the vendored OpenSSL used by `cargo-c`
yum -y install perl-IPC-Cmd

# needed by `pineappl_applgrid` with `--features=static`
yum -y install zlib-static

# install cargo-c needed for the CAPI
cargo install --locked cargo-c --version ${CARGOC_V} --features=vendored-openssl

# remove files generated by cargo
rm -r /usr/local/cargo/registry

# enable tracing
set -x

# install LHAPDF
curl -L "https://lhapdf.hepforge.org/downloads/?f=LHAPDF-${LHAPDF_V}.tar.gz" | tar xzf -
cd LHAPDF-${LHAPDF_V}
# compile static libraries with PIC to make statically linking PineAPPL's CLI work
# see also https://users.rust-lang.org/t/why-does-crelocation-model-dynamic-no-pic-help-although-it-shouldnt/109012
./configure --disable-python --with-pic=yes
make -j V=1
make install
ldconfig
cd ..

# install PDF sets
for pdf in NNPDF31_nlo_as_0118_luxqed NNPDF40_nnlo_as_01180 NNPDF40_nlo_as_01180; do
    curl "https://lhapdfsets.web.cern.ch/current/${pdf}.tar.gz" | tar xzf - -C /usr/local/share/LHAPDF
done

# install zlib compiled with `-fPIC`
curl "https://www.zlib.net/zlib-${ZLIB_V}.tar.gz" | tar xzf -
cd zlib-${ZLIB_V}
CFLAGS=-fPIC ./configure --prefix=/usr/local
make -j
make install
ldconfig
cd ..

# install APPLgrid
curl -L "https://applgrid.hepforge.org/downloads?f=applgrid-${APPLGRID_V}.tgz" | tar xzf -
cd applgrid-${APPLGRID_V}
# compile static libraries with PIC to make statically linking PineAPPL's CLI work
./configure --without-root --with-pic=yes
make -j
make install
ldconfig
mkdir -p ${APPL_IGRID_DIR}
cp src/*.h ${APPL_IGRID_DIR}
cd ..

# install fastNLO
curl "https://fastnlo.hepforge.org/code/v25/fastnlo_toolkit-${FASTNLO_V}.tar.gz" | tar xzf -
cd fastnlo_toolkit-${FASTNLO_V}
# compile static libraries with PIC to make statically linking PineAPPL's CLI work
./configure --prefix=/usr/local/ --with-pic=yes
make -j V=1
make install
ldconfig
cd ..
